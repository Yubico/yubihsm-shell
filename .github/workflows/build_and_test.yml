name: Build and Test

on: [push, pull_request]

jobs:
  build_debian_derivatives:
    strategy:
      fail-fast: false
      matrix:
        environment: [
          "ubuntu:21.10",
          "ubuntu:20.04"
        ]
        cc: [
          "gcc",
          "clang"
        ]

    runs-on: ubuntu-latest
    container: ${{ matrix.environment }}

    steps:

      - name: install dependencies from package management
        env:
          DEBIAN_FRONTEND: noninteractive
          CC: ${{ matrix.cc }}
        run: |
          apt update
          apt install -q -y build-essential cmake pkg-config gengetopt help2man libcurl4-openssl-dev libedit-dev libpcsclite-dev libusb-1.0-0-dev libssl-dev
          if [ "$CC" = "clang" ]; then
            apt install -q -y clang llvm lld
          fi

      - name: clone the Yubico/yubihsm-shell repository
        uses: actions/checkout@v2
        with:
          path: yubihsm-shell

      - name: clone the YubicoLabs/pkcs11test repository
        uses: actions/checkout@v2
        with:
          repository: YubicoLabs/pkcs11test
          path: pkcs11test

      - name: build the pkcs11test binary
        working-directory: pkcs11test
        run: make

      - name: clone the YubicoLabs/python-pkcs11tester repository
        uses: actions/checkout@v2
        with:
          repository: YubicoLabs/python-pkcs11tester
          path: python-pkcs11tester

      - name: do vanilla build
        working-directory: yubihsm-shell
        env:
          CC: ${{ matrix.cc }}
          VERBOSE: 1
          PKCS11TEST_PATH: ..
        run: |
          if [ "$CC" = "gcc" ]; then
            cmake -B build-vanilla
          else
            cmake -B build-vanilla \
              -DCMAKE_AR=/usr/bin/llvm-ar \
              -DCMAKE_RALIB=/usr/bin/llvm-ranlib \
              -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld"
          fi
          cmake --build build-vanilla

      - name: do static build
        working-directory: yubihsm-shell
        env:
          CC: ${{ matrix.cc }}
          VERBOSE: 1
          PKCS11TEST_PATH: ..
        run: |
          if [ "$CC" = "gcc" ]; then
            cmake -DENABLE_STATIC=ON -B build-static
          else
            cmake -DENABLE_STATIC=ON -B build-static \
              -DCMAKE_AR=/usr/bin/llvm-ar \
              -DCMAKE_RALIB=/usr/bin/llvm-ranlib \
              -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld"
          fi
          cmake --build build-static
